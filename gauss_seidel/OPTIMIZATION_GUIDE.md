# è®¿å­˜ä¼˜åŒ–ä½¿ç”¨æŒ‡å—

## å¿«é€Ÿå¼€å§‹

### Windows (æ¨è)
```powershell
# æ–¹å¼1: ä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼ˆè‡ªåŠ¨æµ‹è¯•å¤šç§é…ç½®ï¼‰
.\test_memory_opt.ps1

# æ–¹å¼2: æ‰‹åŠ¨ç¼–è¯‘å’Œæµ‹è¯•
make opt
.\test_memory_optimization.exe 512 8
```

### Linux
```bash
# ç¼–è¯‘
make opt

# è¿è¡Œæµ‹è¯•
./test_memory_optimization.exe 512 8

# æ€§èƒ½åˆ†æï¼ˆå¯é€‰ï¼Œéœ€è¦perfå·¥å…·ï¼‰
make perf
```

---

## æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| [gauss_seidel_2d_optimized.h](gauss_seidel_2d_optimized.h) | ä¼˜åŒ–ç‰ˆæœ¬å¤´æ–‡ä»¶ |
| [gauss_seidel_2d_optimized.cpp](gauss_seidel_2d_optimized.cpp) | ä¸‰ç§ä¼˜åŒ–å®ç° |
| [test_memory_optimization.cpp](test_memory_optimization.cpp) | æ€§èƒ½å¯¹æ¯”æµ‹è¯•ç¨‹åº |
| [MEMORY_OPTIMIZATION_REPORT.md](MEMORY_OPTIMIZATION_REPORT.md) | è¯¦ç»†æŠ€æœ¯æŠ¥å‘Š |
| [test_memory_opt.ps1](test_memory_opt.ps1) | Windowsè‡ªåŠ¨æµ‹è¯•è„šæœ¬ |

---

## ä¸‰ç§ä¼˜åŒ–æ–¹æ¡ˆ

### 1. äºŒçº§Tilingä¼˜åŒ– â­â­â­â­â­ï¼ˆæ¨èï¼‰

**ç‰¹ç‚¹ï¼š**
- æ€§èƒ½æå‡: **1.5x - 2.5x**
- æ— é¢å¤–å†…å­˜å¼€é”€
- å®ç°éš¾åº¦: ä¸­ç­‰

**é€‚ç”¨åœºæ™¯ï¼š**
- æ‰€æœ‰é—®é¢˜è§„æ¨¡
- CPUå¤šæ ¸ç³»ç»Ÿ
- é»˜è®¤æ¨èæ–¹æ¡ˆ

**æŠ€æœ¯ç»†èŠ‚ï¼š**
```cpp
GaussSeidel2DOptimized::solve_parallel_redblack_tiled(
    u, f, N, h, max_iter, tol, iter_count, residual, num_threads);
```

---

### 2. SIMDå‘é‡åŒ–ä¼˜åŒ– âš ï¸ï¼ˆå®éªŒæ€§ï¼‰

**ç‰¹ç‚¹ï¼š**
- æ€§èƒ½æå‡: **1.0x - 1.2x**ï¼ˆæœ‰é™ï¼‰
- æ— é¢å¤–å†…å­˜å¼€é”€
- å®ç°éš¾åº¦: å›°éš¾

**é™åˆ¶ï¼š**
- çº¢é»‘æ’åºçš„è·¨æ­¥è®¿é—®é™åˆ¶SIMDæ•ˆæœ
- éœ€è¦AVX2æ”¯æŒ
- ç¼–è¯‘å™¨ä¼˜åŒ–ä¾èµ–æ€§å¼º

**æŠ€æœ¯ç»†èŠ‚ï¼š**
```cpp
GaussSeidel2DOptimized::solve_parallel_redblack_simd(
    u, f, N, h, max_iter, tol, iter_count, residual, num_threads);
```

---

### 3. æ•°æ®é‡æ’ä¼˜åŒ– ğŸ’°ï¼ˆé«˜æ€§èƒ½é«˜ä»£ä»·ï¼‰

**ç‰¹ç‚¹ï¼š**
- æ€§èƒ½æå‡: **2.0x - 3.0x**
- é¢å¤–å†…å­˜: 2NÂ² + æ˜ å°„è¡¨
- å®ç°éš¾åº¦: å¾ˆéš¾

**é€‚ç”¨åœºæ™¯ï¼š**
- å¤§è§„æ¨¡é—®é¢˜ (N >= 1024)
- é«˜è¿­ä»£æ¬¡æ•° (>= 500æ¬¡)
- å†…å­˜å……è¶³çš„ç³»ç»Ÿ

**æŠ€æœ¯ç»†èŠ‚ï¼š**
```cpp
GaussSeidel2DOptimized::solve_parallel_redblack_restructured(
    u, f, N, h, max_iter, tol, iter_count, residual, num_threads);
```

---

## æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹

å…¸å‹è¾“å‡ºï¼ˆN=512, 8çº¿ç¨‹ï¼‰ï¼š

```
============================================================
æ–¹æ³•: åŸºå‡†: å½“å‰å®ç° (æ— åˆ†å—)
------------------------------------------------------------
ç½‘æ ¼è§„æ¨¡:        512 x 512
è¿­ä»£æ¬¡æ•°:        342
æœ€ç»ˆæ®‹å·®:        9.876543e-07
ç›¸å¯¹è¯¯å·®:        1.234567e-06
è®¡ç®—æ—¶é—´:        186.234 ms
æ¯æ¬¡è¿­ä»£æ—¶é—´:    0.544 ms
============================================================

============================================================
æ–¹æ³•: ä¼˜åŒ–1: äºŒçº§Tiling + é¢„å– + æ•°æ®é‡ç”¨
------------------------------------------------------------
ç½‘æ ¼è§„æ¨¡:        512 x 512
è¿­ä»£æ¬¡æ•°:        342
æœ€ç»ˆæ®‹å·®:        9.876543e-07
ç›¸å¯¹è¯¯å·®:        1.234567e-06
è®¡ç®—æ—¶é—´:        92.156 ms
æ¯æ¬¡è¿­ä»£æ—¶é—´:    0.269 ms
åŠ é€Ÿæ¯”:          2.02x
æ€§èƒ½æå‡:        50.5%
============================================================
```

---

## ç¼–è¯‘è¦æ±‚

### å¿…éœ€
- C++11ç¼–è¯‘å™¨
- OpenMPæ”¯æŒ
- x86-64æ¶æ„

### å¯é€‰ï¼ˆç”¨äºå®Œæ•´ä¼˜åŒ–ï¼‰
- AVX2æŒ‡ä»¤é›†æ”¯æŒ
- g++ 5.0+ æˆ– clang 3.9+
- `-march=native` æ”¯æŒ

### ç¼–è¯‘é€‰é¡¹è¯´æ˜
```bash
# åŸºç¡€ä¼˜åŒ–
-O3                    # æœ€é«˜ä¼˜åŒ–çº§åˆ«
-march=native          # é’ˆå¯¹å½“å‰CPUä¼˜åŒ–
-fopenmp               # OpenMPæ”¯æŒ

# æ¿€è¿›ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
-mavx2                 # å¯ç”¨AVX2
-mfma                  # å¯ç”¨FMAæŒ‡ä»¤
-funroll-loops         # å¾ªç¯å±•å¼€
```

---

## å¸¸è§é—®é¢˜

### Q1: ç¼–è¯‘æ—¶å‡ºç°AVX2é”™è¯¯ï¼Ÿ
**A:** ä½ çš„CPUå¯èƒ½ä¸æ”¯æŒAVX2ã€‚ç¼–è¾‘Makefileï¼Œå°†`CXXFLAGS_OPT`ä¸­çš„`-mavx2`åˆ é™¤ã€‚

### Q2: æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Ÿ
**A:** å¯èƒ½åŸå› ï¼š
1. é—®é¢˜è§„æ¨¡å¤ªå° (N < 256)ï¼Œå»ºè®®æµ‹è¯•N=512æˆ–æ›´å¤§
2. çº¿ç¨‹æ•°è¿‡å¤šå¯¼è‡´ç«äº‰ï¼Œå°è¯•å‡å°‘çº¿ç¨‹æ•°
3. ç³»ç»Ÿæœ‰å…¶ä»–è´Ÿè½½ï¼Œå…³é—­å…¶ä»–ç¨‹åºé‡æ–°æµ‹è¯•

### Q3: å¦‚ä½•é€‰æ‹©æœ€ä½³æ–¹æ¡ˆï¼Ÿ
**A:** å†³ç­–æ ‘ï¼š
```
N < 256?
  â””â”€ æ˜¯ â†’ ä½¿ç”¨åŸºå‡†ç‰ˆæœ¬ï¼ˆä¼˜åŒ–æ”¶ç›Šå°ï¼‰
  â””â”€ å¦ â†’ ç»§ç»­
  
å†…å­˜å……è¶³ ä¸” N >= 1024?
  â””â”€ æ˜¯ â†’ å°è¯•æ•°æ®é‡æ’ï¼ˆæœ€å¿«ï¼‰
  â””â”€ å¦ â†’ ä½¿ç”¨äºŒçº§Tilingï¼ˆæ¨èï¼‰
```

### Q4: èƒ½å¦åº”ç”¨åˆ°3Dç‰ˆæœ¬ï¼Ÿ
**A:** å¯ä»¥ï¼æ ¸å¿ƒæ€æƒ³ç›¸åŒï¼š
- 3Då·²æœ‰åˆ†å—ï¼Œå¯ä¼˜åŒ–ä¸ºè‡ªé€‚åº”tileå¤§å°
- å¯æ·»åŠ è½¯ä»¶é¢„å–
- 3Dç‰¹æœ‰ä¼˜åŒ–ï¼š8è‰²å¹¶è¡Œï¼ˆè§æŠ¥å‘Šç¬¬4.2èŠ‚ï¼‰

---

## è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

å¦‚æœéœ€è¦æ›´é«˜æ€§èƒ½ï¼Œè€ƒè™‘ï¼š

1. **GPUç§»æ¤** (10x-100xåŠ é€Ÿ)
   - ä½¿ç”¨CUDAæˆ–HIP
   - å‚è€ƒ `optimizing-gauss-seidel-iteration/` çš„å®ç°

2. **å¤šç½‘æ ¼æ–¹æ³•** (ç®—æ³•å±‚é¢)
   - å‡å°‘è¿­ä»£æ¬¡æ•°
   - æ›´å¿«æ”¶æ•›

3. **æ··åˆç²¾åº¦è®¡ç®—**
   - è¿­ä»£ç”¨floatï¼ŒéªŒè¯ç”¨double
   - å‡å°‘å†…å­˜å¸¦å®½éœ€æ±‚

4. **NUMAä¼˜åŒ–** (å¤šSocketç³»ç»Ÿ)
   - æœ¬åœ°å†…å­˜åˆ†é…
   - å‡å°‘è·¨Socketé€šä¿¡

---

## æ€§èƒ½åˆ†æå·¥å…·

### Windows
```powershell
# Intel VTune (å¦‚æœæœ‰)
vtune -collect memory-access .\test_memory_optimization.exe 512 8
```

### Linux
```bash
# perf
perf stat -e cache-misses,cache-references \
    ./test_memory_optimization.exe 512 8

# valgrind cachegrind
valgrind --tool=cachegrind ./test_memory_optimization.exe 256 4
cg_annotate cachegrind.out.<pid>
```

---

## å‚è€ƒèµ„æ–™

- è¯¦ç»†æŠ€æœ¯æŠ¥å‘Š: [MEMORY_OPTIMIZATION_REPORT.md](MEMORY_OPTIMIZATION_REPORT.md)
- GPUç‰ˆæœ¬å‚è€ƒ: [../optimizing-gauss-seidel-iteration/](../optimizing-gauss-seidel-iteration/)
- Intelä¼˜åŒ–æ‰‹å†Œ: https://www.intel.com/content/www/us/en/develop/documentation/cpp-compiler-developer-guide-and-reference/

---

## è®¸å¯è¯

æœ¬ä»£ç ä»…ä¾›å­¦ä¹ ç ”ç©¶ä½¿ç”¨ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤Issueså’ŒPull Requestsï¼
